<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin / Dispatch | Towa PH</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="topbar">
        <div class="brand">
            <img src="assets/towa_logo.png" alt="TOWA Philippines" class="logo">
            <span>Admin / Dispatch</span>
        </div>
        <nav class="nav">
            <a href="index.html">Home</a>
            <a href="#board">Board</a>
            <a href="#approvals">Approvals</a>
            <a href="#inventory">Inventory</a>
            <a href="#kpi">KPIs</a>
        </nav>
        <div class="cta-row">
            <a class="btn" href="index.html#portals">Back to Site</a>
        </div>
    </header>

    <main>
        <section class="section" id="board">
            <div class="section-header">
                <p class="eyebrow">Dispatch</p>
                <h2>Kanban board</h2>
                <p class="lede">Track jobs across New · Scheduled · Enroute · Onsite · Waiting Parts · Done.</p>
            </div>
            <div class="kanban" id="kanban-root">
                <!-- Kanban columns rendered by JS -->
            </div>
        </section>

        <section class="section muted" id="approvals">
            <div class="section-header">
                <p class="eyebrow">Approvals</p>
                <h2>Quotes, discounts, exceptions</h2>
                <p class="lede">Approve pricing, schedule overrides, and travel exceptions.</p>
            </div>
            <div class="bar">
                <div>
                    <h3>Pending approvals</h3>
                    <p class="fine" id="approvals-summary">Loading…</p>
                </div>
                <a class="btn ghost" href="#approvals-list" id="approvals-link">Review</a>
            </div>
            <div id="approvals-list" style="margin-top:12px"></div>
        </section>

        <section class="section" id="inventory">
            <div class="section-header">
                <p class="eyebrow">Inventory</p>
                <h2>Stock & lead times</h2>
                <p class="lede">See critical spares, ETAs, and reservations per job.</p>
            </div>
            <div class="grid two">
                <article class="card compact">
                    <h3>Critical spares</h3>
                    <p>Blades, filters, sensors, compression kit.</p>
                    <p class="fine">Low stock alert: filters.</p>
                </article>
                <article class="card compact">
                    <h3>Reservations</h3>
                    <p>Hold parts tied to scheduled jobs; auto-release after completion.</p>
                </article>
            </div>
        </section>

        <section class="section muted" id="kpi">
            <div class="section-header">
                <p class="eyebrow">KPIs</p>
                <h2>Ops metrics</h2>
                <p class="lede">Monitor MTTR, first-time-fix, backlog, and SLA compliance.</p>
            </div>
            <div class="grid two">
                <article class="card compact">
                    <h3>MTTR / SLA</h3>
                    <p>MTTR: 6.2h · SLA hit: 95%</p>
                </article>
                <article class="card compact">
                    <h3>Backlog</h3>
                    <p>New: 4 · Waiting Parts: 2 · Scheduled: 5</p>
                </article>
            </div>
        </section>
    </main>
    <script>
        // Admin portal functionality (local demo using localStorage)
        const STATUSES = ['queued', 'scheduled', 'enroute', 'onsite', 'waiting parts', 'finished'];

        function safeLoad(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || '[]')
            } catch (e) {
                return []
            }
        }

        function safeSave(key, val) {
            localStorage.setItem(key, JSON.stringify(val));
        }

        function renderKanban() {
            const root = document.getElementById('kanban-root');
            root.innerHTML = '';
            const jobs = safeLoad('fse_jobs');
            STATUSES.forEach(status => {
                const col = document.createElement('div');
                col.style = minColStyle();
                const header = document.createElement('div');
                header.className = 'card';
                header.style.padding = '8px';
                header.innerHTML = `<strong style="text-transform:capitalize">${status.replace(/\b\w/g,c=>c.toUpperCase())}</strong><div class="small">${jobs.filter(j=> (j.status||'queued')===status).length} items</div>`;
                col.appendChild(header);
                const list = document.createElement('div');
                list.style.display = 'flex';
                list.style.flexDirection = 'column';
                list.style.gap = '8px';
                list.style.marginTop = '8px';
                jobs.filter(j => (j.status || 'queued') === status).forEach(job => {
                    const card = document.createElement('div');
                    card.className = 'card compact';
                    card.innerHTML = `<div style='display:flex;justify-content:space-between;gap:8px;align-items:center'><div><strong>${job.title}</strong><div class='small'>${job.model||''} · ${job.location||''}</div></div></div>`;
                    const actions = document.createElement('div');
                    actions.style.marginTop = '8px';
                    const select = document.createElement('select');
                    STATUSES.forEach(s => {
                        const o = document.createElement('option');
                        o.value = s;
                        o.textContent = s[0].toUpperCase() + s.slice(1);
                        if (s === (job.status || 'queued')) o.selected = true;
                        select.appendChild(o);
                    });
                    select.addEventListener('change', () => {
                        const all = safeLoad('fse_jobs');
                        const i = all.findIndex(x => x.created === job.created);
                        if (i > -1) {
                            all[i].status = select.value;
                            safeSave('fse_jobs', all);
                            renderKanban();
                            renderApprovals();
                            renderKPIs();
                        }
                    });
                    const finishBtn = document.createElement('button');
                    finishBtn.className = 'btn';
                    finishBtn.textContent = 'Finish';
                    finishBtn.style.marginLeft = '8px';
                    finishBtn.addEventListener('click', () => {
                        if (confirm('Mark job finished?')) {
                            const all = safeLoad('fse_jobs');
                            const i = all.findIndex(x => x.created === job.created);
                            if (i > -1) {
                                all[i].status = 'finished';
                                safeSave('fse_jobs', all);
                                renderKanban();
                                renderKPIs();
                            }
                        }
                    });
                    const del = document.createElement('button');
                    del.className = 'btn ghost';
                    del.textContent = 'Delete';
                    del.style.marginLeft = '8px';
                    del.addEventListener('click', () => {
                        if (confirm('Delete job?')) {
                            const all = safeLoad('fse_jobs');
                            const i = all.findIndex(x => x.created === job.created);
                            if (i > -1) {
                                all.splice(i, 1);
                                safeSave('fse_jobs', all);
                                renderKanban();
                                renderKPIs();
                            }
                        }
                    });
                    actions.appendChild(select);
                    actions.appendChild(finishBtn);
                    actions.appendChild(del);
                    card.appendChild(actions);
                    list.appendChild(card);
                });
                col.appendChild(list);
                root.appendChild(col);
            });
        }

        function minColStyle() {
            return 'display:flex;flex-direction:column;gap:8px;'
        }

        function renderApprovals() {
            const out = document.getElementById('approvals-list');
            out.innerHTML = '';
            const reqs = safeLoad('access_requests');
            document.getElementById('approvals-summary').textContent = `${reqs.length} open requests`;
            if (!reqs.length) {
                out.innerHTML = '<div class="small">No pending access requests.</div>';
                return
            }
            reqs.forEach((r, idx) => {
                const c = document.createElement('div');
                c.className = 'card';
                c.innerHTML = `<strong>${r.email}</strong><div class='small'>Role: ${r.role||'user'}</div><div class='small'>Message: ${r.message||''}</div>`;
                const actions = document.createElement('div');
                actions.className = 'card-ctas';
                const approve = document.createElement('button');
                approve.className = 'btn';
                approve.textContent = 'Approve';
                approve.addEventListener('click', () => {
                    const users = safeLoad('portal_users');
                    users.push({
                        email: r.email,
                        role: r.role || 'customer',
                        approved: true
                    });
                    safeSave('portal_users', users);
                    reqs.splice(idx, 1);
                    safeSave('access_requests', reqs);
                    renderApprovals();
                    alert('Approved ' + r.email);
                });
                const reject = document.createElement('button');
                reject.className = 'btn ghost';
                reject.textContent = 'Reject';
                reject.addEventListener('click', () => {
                    if (confirm('Reject request?')) {
                        reqs.splice(idx, 1);
                        safeSave('access_requests', reqs);
                        renderApprovals();
                    }
                });
                actions.appendChild(approve);
                actions.appendChild(reject);
                c.appendChild(actions);
                out.appendChild(c);
            });
        }

        function renderInventory() {
            const jobs = safeLoad('fse_jobs');
            const reports = safeLoad('fse_reports');
            const punch = safeLoad('fse_attendance');
            // example: count finished vs open
            const open = jobs.filter(j => (j.status || 'queued') !== 'finished').length;
            const finished = jobs.filter(j => (j.status || 'queued') === 'finished').length;
            const invSection = document.querySelector('#inventory .grid');
            // update first card content
            if (invSection && invSection.children[0]) {
                invSection.children[0].querySelector('p').textContent = `Open: ${open} · Finished: ${finished}`;
            }
            if (invSection && invSection.children[1]) {
                invSection.children[1].querySelector('p').textContent = `Reports: ${reports.length} · Punches: ${punch.length}`;
            }
        }

        function renderKPIs() {
            const jobs = safeLoad('fse_jobs');
            const total = jobs.length;
            const finished = jobs.filter(j => (j.status || 'queued') === 'finished').length;
            const backlog = jobs.filter(j => (j.status || 'queued') !== 'finished').length;
            const kpiSection = document.querySelector('#kpi .grid');
            if (kpiSection && kpiSection.children[0]) kpiSection.children[0].querySelector('p').textContent = `Jobs total: ${total}`;
            if (kpiSection && kpiSection.children[1]) kpiSection.children[1].querySelector('p').textContent = `Backlog: ${backlog} · Finished: ${finished}`;
        }

        // storage change listener to keep admin in sync
        window.addEventListener('storage', (e) => {
            if (['fse_jobs', 'fse_reports', 'fse_attendance', 'access_requests', 'portal_users'].includes(e.key)) {
                renderKanban();
                renderApprovals();
                renderInventory();
                renderKPIs();
            }
        });

        // init
        renderKanban();
        renderApprovals();
        renderInventory();
        renderKPIs();

        // expose small helper for testing
        window._admin = {
            renderKanban,
            renderApprovals
        };
    </script>
</body>

</html>